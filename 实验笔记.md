
# 2024-07-17

今天运行了脚本：`/data/3dPrinter/3_AutoSDF-master/launchers/1_train_pvqvae_snet.sh`

## 1. 修改了 snet_dataset.py 中的 class ShapeNetDataset(BaseDataset)
我修改了这个文件 `/data/3dPrinter/3_AutoSDF-master/datasets/snet_dataset.py` 主要是修改了 一些 ShapeNetDataset 的 def __getitem__(self, index) 方法，我修改了:

### (1) 修改了 各种 paths

```python
# == 修改1: 改变 info.json 的地址 ============================ 开始 =================================
        with open(f'{dataroot}/ShapeNet/ShapeNetCore.v1/info.json') as f:
            self.info = json.load(f)
        # == 修改1: 改变 info.json 的地址 ============================ 结束 =================================

            # == 修改2: 改变 filelists 文件夹(用来 split 数据集) 的地址 ============================ 开始 =================================
            # with open(osp.join(data_dir, 'filelists', '{}_{}.lst'.format(synset, split))) as f:
            with open(f'{dataroot}/ShapeNet/ShapeNetCore.v1/filelists/{synset}_{phase}.lst') as f:
            # == 修改2: 改变 filelists 文件夹(用来 split 数据集) 的地址 ============================ 结束 =================================

                    # == 修改3: 改变 SDF 文件夹的地址 ============================ 开始 =================================
                    # path = f'{dataroot}/ShapeNetCore_v1/SDF_v1_64/{synset}/{model_id}/ori_sample_grid.h5'
                    path = f'{dataroot}/ShapeNet/SDF_v1_64/{synset}/{model_id}/ori_sample.h5'
                    # == 修改3: 改变 SDF 文件夹的地址 ============================ 结束 =================================

```

### (2) 修改了 各种 reshapes

```python
    # === 修改4: 修改 __getitem__ 函数中的 reshape 功能 ============================ 开始 ================================= 
    def __getitem__(self, index):
        synset = self.cats_list[index]
        sdf_h5_file = self.model_list[index]
        
        h5_f = h5py.File(sdf_h5_file, 'r')
        sdf = h5_f['pc_sdf_sample'][:].astype(np.float32)
        # print(f"Original SDF shape: {sdf.shape}") # (32768, 4)
        
        # 假设 sdf 的形状是 (32768, 4)，其中最后一列是 SDF 值
        # 我们需要重塑它为 (32, 32, 32, 1)
        sdf_values = sdf[:, -1]  # 提取 SDF 值
        sdf_reshaped = sdf_values.reshape(32, 32, 32, 1)
        
        # 转换为 PyTorch 张量并添加批次维度
        sdf_tensor = torch.from_numpy(sdf_reshaped).float().permute(3, 0, 1, 2)
        # print(f"Reshaped SDF tensor shape: {sdf_tensor.shape}") # torch.Size([1, 32, 32, 32])

        thres = self.opt.trunc_thres
        if thres != 0.0:
            sdf_tensor = torch.clamp(sdf_tensor, min=-thres, max=thres)

        ret = {
            'sdf': sdf_tensor,
            'cat_id': synset,
            'cat_str': self.id_to_cat[synset],
            'path': sdf_h5_file,
        }

        # 这个修改假设：

        # SDF 数据存储为 32x32x32 的网格，总共有 32768 个点。
        # 每个点有 4 个值，最后一个值是 SDF 值。

        return ret # 返回值是一个字典，包含 SDF 数据、类别 ID、类别字符串和路径。
    # === 修改4: 修改 __getitem__ 函数中的 reshape 功能 ============================ 结束 =================================
```

## 2. 修改了 pvqvae_model.py 中的 各种东西

因为只是跟着 gpt4 一直 debug 所以暂时还不确定是否调通了
